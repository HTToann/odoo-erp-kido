{% extends "baseIndex.html" %} {% block title %}Hóa đơn & Thanh toán{% endblock
%} {% block content %}
<div class="container mt-4">
  <div
    class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2"
  >
    <h2 class="mb-0">Hóa đơn nhà cung cấp</h2>
    <a href="{{ url_for('invoice_web.invoice_add') }}" class="btn btn-success"
      >+ Nhập hóa đơn</a
    >
  </div>

  <div class="card mb-3">
    <div class="card-body d-flex flex-wrap gap-2">
      <div class="flex-grow-1">
        <input
          id="q"
          type="search"
          class="form-control"
          placeholder="Tìm mã HĐ, PO, Nhà cung cấp..."
        />
      </div>
      <div style="min-width: 240px">
        <select id="statusFilter" class="form-select">
          <option value="">-- Tất cả trạng thái --</option>
          <option value="draft">draft</option>
          <option value="validated">validated</option>
          <option value="partially_paid">partially_paid</option>
          <option value="paid">paid</option>
          <option value="canceled">canceled</option>
        </select>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle" id="invoice-table">
      <thead class="table-success align-middle">
        <tr>
          <th style="width: 100px">Mã HĐ</th>
          <th>Nhà cung cấp</th>
          <th style="width: 140px">PO</th>
          <th style="width: 140px">Ngày HĐ</th>
          <th class="text-end" style="width: 160px">Tổng tiền</th>
          <th style="width: 140px">Trạng thái</th>
          <th style="width: 250px">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        {% for inv in invoices %} {% set st = inv.status|lower if inv.status is
        string else inv.status.value|lower %} {% set badge =
        {'draft':'secondary','validated':'info','partially_paid':'warning','paid':'success','canceled':'danger'}.get(st,'secondary')
        %}
        <tr
          data-search="{{ ('INV#' ~ inv.id ~ ' ' ~ (inv.po.po_no if inv.po else '') ~ ' ' ~ (inv.supplier.name if inv.supplier else ''))|lower }}"
          data-status="{{ st }}"
        >
          <td class="fw-semibold">INV#{{ inv.id }}</td>
          <td>{{ inv.supplier.name if inv.supplier else '' }}</td>
          <td>{{ inv.po.po_no if inv.po else '' }}</td>
          <td>
            {{ inv.issued_at.strftime('%Y-%m-%d') if inv.issued_at else '' }}
          </td>
          <td class="text-end">{{ '{:,.2f}'.format(inv.total or 0) }}</td>
          <td>
            <span class="badge text-bg-{{ badge }} text-uppercase"
              >{{ st }}</span
            >
          </td>
          <td class="d-flex flex-wrap gap-2">
            <a
              href="{{ url_for('invoice_web.invoice_edit', invoice_id=inv.id) }}"
              class="btn btn-sm btn-outline-primary"
              >Sửa</a
            >
            {% if st != 'paid' and st != 'canceled' %}
            <a
              href="{{ url_for('payment_web.payment_add', invoice_id=inv.id) }}"
              class="btn btn-sm btn-success"
              >Thanh toán</a
            >
            {% endif %}
            <form
              method="post"
              action="{{ url_for('invoice_web.invoice_delete', invoice_id=inv.id) }}"
              onsubmit="return confirm('Xóa hóa đơn này?')"
            >
              <button class="btn btn-sm btn-outline-danger">Xóa</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="text-center py-4 text-muted">
            Chưa có hóa đơn
          </td>
        </tr>
        {% endfor %}
      </tbody>

      <!-- {% if invoices and invoices|length > 0 %}
      <tfoot>
        <tr>
          <th colspan="4" class="text-end">Tổng cộng</th>
          <th class="text-end">
            {{ '{:,.2f}'.format(invoices | map(attribute='total') | sum) }}
          </th>
          <th colspan="2"></th>
        </tr>
      </tfoot>
      {% endif %} -->
    </table>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  (function () {
    const q = document.getElementById("q");
    const statusSel = document.getElementById("statusFilter");
    const rows = [...document.querySelectorAll("#invoice-table tbody tr")];

    function applyFilter() {
      const kw = (q.value || "").trim().toLowerCase();
      const st = (statusSel.value || "").toLowerCase();
      rows.forEach((tr) => {
        const passKw = !kw || (tr.dataset.search || "").includes(kw);
        const passSt = !st || (tr.dataset.status || "") === st;
        tr.style.display = passKw && passSt ? "" : "none";
      });
    }
    q.addEventListener("input", applyFilter);
    statusSel.addEventListener("change", applyFilter);
  })();
</script>
{% endblock %}
