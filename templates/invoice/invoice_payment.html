{% extends "baseIndex.html" %} {% block title %}Hóa đơn & Thanh toán{% endblock
%} {% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Hóa đơn nhà cung cấp</h2>

  <div class="mb-3 d-flex gap-2">
    <a href="{{ url_for('invoice_web.invoice_add') }}" class="btn btn-success"
      >+ Nhập hóa đơn</a
    >
  </div>

  <table class="table table-bordered table-striped align-middle">
    <thead class="table-success">
      <tr>
        <th>Mã HĐ</th>
        <th>Nhà cung cấp</th>
        <th>PO</th>
        <th>Ngày HĐ</th>
        <th class="text-end">Tổng tiền</th>
        <th>Trạng thái</th>
        <th style="width: 220px">Thao tác</th>
      </tr>
    </thead>
    <tbody>
      {% for inv in invoices %} {# ---- chuẩn hóa status về lowercase string, an
      toàn với Enum hoặc string ---- #} {% if inv.status is string %} {% set st
      = inv.status|lower %} {% else %} {% set st = inv.status.value|lower %} {%
      endif %} {# ---- map badge theo trạng thái ---- #} {% set badge = {
      'draft':'secondary', 'validated':'info', 'partially_paid':'warning',
      'paid':'success', 'canceled':'danger' }.get(st, 'secondary') %}

      <tr>
        <td>INV#{{ inv.id }}</td>
        <td>{{ inv.supplier.name if inv.supplier else '' }}</td>
        <td>{{ inv.po.po_no if inv.po else '' }}</td>
        <td>
          {{ inv.issued_at.strftime('%Y-%m-%d') if inv.issued_at else '' }}
        </td>
        <td class="text-end">{{ '{:,.2f}'.format(inv.total or 0) }}</td>
        <td>
          <span class="badge text-bg-{{ badge }} text-uppercase">{{ st }}</span>
        </td>
        <td class="d-flex flex-wrap gap-2">
          <a
            href="{{ url_for('invoice_web.invoice_edit', invoice_id=inv.id) }}"
            class="btn btn-sm btn-warning"
            >Sửa</a
          >

          <form
            method="post"
            action="{{ url_for('invoice_web.invoice_delete', invoice_id=inv.id) }}"
            onsubmit="return confirm('Xóa hóa đơn này?')"
          >
            <button class="btn btn-sm btn-danger">Xóa</button>
          </form>

          {% if st != 'paid' %}
          <a
            href="{{ url_for('payment_web.payment_add', invoice_id=inv.id) }}"
            class="btn btn-sm btn-primary"
            >Thanh toán</a
          >
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="7" class="text-center">Chưa có hóa đơn</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
