{% extends "baseIndex.html" %}
{% block title %}{{ "Nhập" if action=="add" else "Sửa" }} Hóa đơn NCC{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">{{ "Nhập" if action=="add" else "Sửa" }} Hóa đơn nhà cung cấp</h2>

  <form method="post">
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label class="form-label">Nhà cung cấp</label>
        <select name="supplier_id" class="form-select" required>
          <option value="">-- chọn --</option>
          {% for s in suppliers %}
            <option value="{{ s.id }}" {% if inv and inv.supplier_id==s.id %}selected{% endif %}>
              {{ s.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Đơn mua (PO)</label>
        <select name="po_id" class="form-select">
          <option value="">-- không --</option>
          {% for p in purchases %}
            <option value="{{ p.id }}" {% if inv and inv.po_id==p.id %}selected{% endif %}>
              {{ p.po_no }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Trạng thái</label>
        {% if inv %}
          {% set st = inv.status|lower if inv.status is string else inv.status.value|lower %}
        {% else %}
          {% set st = 'draft' %}
        {% endif %}
        <select name="status" class="form-select">
          <option value="draft"           {% if st=='draft' %}selected{% endif %}>draft</option>
          <option value="validated"       {% if st=='validated' %}selected{% endif %}>validated</option>
          <option value="partially_paid"  {% if st=='partially_paid' %}selected{% endif %}>partially_paid</option>
          <option value="paid"            {% if st=='paid' %}selected{% endif %}>paid</option>
          <option value="canceled"        {% if st=='canceled' %}selected{% endif %}>canceled</option>
        </select>
      </div>
    </div>

    <h5>Dòng hóa đơn</h5>
    <div class="table-responsive mb-3">
      <table class="table table-bordered align-middle" id="inv-lines">
        <thead class="table-light">
          <tr>
            <th>Nguyên liệu</th>
            <th style="width:18%">Số lượng</th>
            <th style="width:18%">Đơn giá</th>
            <th style="width:15%" class="text-end">Thành tiền</th>
            <th style="width:8%"></th>
          </tr>
        </thead>
        <tbody>
          {% set lines = inv.lines if inv else [] %}
          {% for ln in lines %}
            {% set i = loop.index0 %}
            {% set line_total = ((ln.qty or 0) * (ln.price or 0)) %}
            <tr>
              <td>
                <select name="lines[{{ i }}][material_id]" class="form-select" required>
                  <option value="">-- chọn --</option>
                  {% for m in materials %}
                    <option value="{{ m.id }}" {% if ln.material_id==m.id %}selected{% endif %}>
                      {{ m.sku }} - {{ m.name }}
                    </option>
                  {% endfor %}
                </select>
              </td>
              <td><input name="lines[{{ i }}][qty]" type="number" step="0.001" min="0" class="form-control" value="{{ ln.qty }}"></td>
              <td><input name="lines[{{ i }}][price]" type="number" step="0.01" min="0" class="form-control" value="{{ ln.price }}"></td>
              <td class="text-end fw-semibold line-total">{{ '%.2f'|format(line_total) }}</td>
              <td><button type="button" class="btn btn-outline-danger btn-sm remove-line">X</button></td>
            </tr>
          {% else %}
            <tr>
              <td>
                <select name="lines[0][material_id]" class="form-select" required>
                  <option value="">-- chọn --</option>
                  {% for m in materials %}
                    <option value="{{ m.id }}">{{ m.sku }} - {{ m.name }}</option>
                  {% endfor %}
                </select>
              </td>
              <td><input name="lines[0][qty]" type="number" step="0.001" min="0" class="form-control" value="1"></td>
              <td><input name="lines[0][price]" type="number" step="0.01" min="0" class="form-control" value="0"></td>
              <td class="text-end fw-semibold line-total">0.00</td>
              <td><button type="button" class="btn btn-outline-danger btn-sm remove-line">X</button></td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="3" class="text-end">Tổng</th>
            <th class="text-end" id="inv-total">0.00</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="d-flex gap-2">
      <button type="button" id="add-line" class="btn btn-outline-secondary">+ Thêm dòng</button>
      <button class="btn btn-success">Lưu</button>
      <a href="{{ url_for('invoice_web.invoice_list') }}" class="btn btn-secondary">Hủy</a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const tbl = document.getElementById('inv-lines').querySelector('tbody');
  const addBtn = document.getElementById('add-line');
  const totalEl = document.getElementById('inv-total');

  function reindex(){
    [...tbl.querySelectorAll('tr')].forEach((tr,i)=>{
      tr.querySelectorAll('select,input').forEach(el=>{
        el.name = el.name.replace(/lines\[\d+\]/, `lines[${i}]`);
      });
    });
  }

  function calc(){
    let sum = 0;
    tbl.querySelectorAll('tr').forEach(tr=>{
      const qty   = parseFloat(tr.querySelector('input[name*="[qty]"]').value || 0);
      const price = parseFloat(tr.querySelector('input[name*="[price]"]').value || 0);
      const lt = (qty * price) || 0;
      tr.querySelector('.line-total').textContent = lt.toFixed(2);
      sum += lt;
    });
    totalEl.textContent = sum.toFixed(2);
  }

  addBtn.addEventListener('click', ()=>{
    const tr = tbl.querySelector('tr:last-child').cloneNode(true);
    tr.querySelectorAll('input').forEach(i=> i.value = i.name.includes('[qty]') ? '1' : '0');
    tr.querySelectorAll('select').forEach(s=> s.selectedIndex = 0);
    tr.querySelector('.line-total').textContent = '0.00';
    tbl.appendChild(tr);
    reindex(); calc();
  });

  tbl.addEventListener('input', e=>{
    if(e.target.matches('input')) calc();
  });

  tbl.addEventListener('click', e=>{
    if(e.target.classList.contains('remove-line')){
      const rows = tbl.querySelectorAll('tr');
      if(rows.length > 1){
        e.target.closest('tr').remove();
        reindex(); calc();
      }
    }
  });

  // tính tổng ban đầu
  calc();
})();
</script>
{% endblock %}
